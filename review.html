<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AI Kit - Field Documentation</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
    <meta name="theme-color" content="#0a1628">

    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FieldVoice">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-slate': '#334155',
                        'dot-orange': '#ea580c',
                        'dot-yellow': '#f59e0b',
                        'safety-green': '#16a34a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        .header-stripe {
            background: repeating-linear-gradient(-45deg, #f59e0b, #f59e0b 10px, #0a1628 10px, #0a1628 20px);
            height: 4px;
            padding-top: env(safe-area-inset-top);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .editable-area {
            min-height: 50px;
            outline: none;
            padding: 10px 12px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .editable-area:hover {
            background-color: rgba(30, 58, 95, 0.03);
        }
        .editable-area:focus {
            background-color: rgba(30, 58, 95, 0.06);
            border-color: #1e3a5f;
        }
        .editable-area[data-placeholder]:empty:before {
            content: attr(data-placeholder);
            color: rgba(0,0,0,0.3);
            font-style: italic;
        }
        .section-na {
            opacity: 0.5;
        }
        /* Photo caption styles */
        .photo-caption-input {
            width: 100%;
            min-height: 2em;
            max-height: 6em;
            resize: none;
            overflow-y: hidden;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 11px;
            line-height: 1.3;
            background: #f8fafc;
            color: #475569;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .photo-caption-input:focus {
            outline: none;
            border-color: #1e3a5f;
            background: #fff;
        }
        .photo-caption-input::placeholder {
            color: #94a3b8;
            font-style: italic;
        }
        .photo-caption-display {
            font-size: 11px;
            color: #64748b;
            font-style: italic;
            line-height: 1.3;
            word-break: break-word;
        }
        .photo-caption-counter {
            font-size: 9px;
            color: #94a3b8;
            text-align: right;
        }
        .photo-caption-counter.warning { color: #ea580c; }
        .photo-caption-counter.error { color: #dc2626; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">
    <div class="header-stripe"></div>

    <div id="app" class="max-w-3xl mx-auto min-h-screen flex flex-col">

        <!-- HEADER -->
        <header class="sticky top-0 z-20 bg-dot-navy text-white">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex gap-2">
                    <a href="index.html" class="w-9 h-9 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors" title="Home">
                        <i class="fas fa-home text-slate-400 text-sm"></i>
                    </a>
                    <a href="quick-interview.html" class="w-9 h-9 flex items-center justify-center border border-slate-600 hover:bg-slate-800 transition-colors" title="Back to Interview">
                        <i class="fas fa-arrow-left text-slate-400 text-sm"></i>
                    </a>
                    <button onclick="showCancelConfirmation()" class="w-9 h-9 flex items-center justify-center border border-red-600/50 hover:bg-red-600/20 transition-colors" title="Cancel Report">
                        <i class="fas fa-times text-red-400 text-sm"></i>
                    </button>
                </div>
                <div class="text-center flex-1 mx-4">
                    <p class="text-[10px] font-bold text-safety-green uppercase tracking-widest">AI Kit</p>
                    <p id="currentDate" class="text-xs text-slate-400"></p>
                </div>
                <div class="flex gap-2">
                    <button onclick="exportTrainingData()" class="w-9 h-9 flex items-center justify-center border border-slate-600 hover:bg-slate-800 text-violet-400 transition-colors" title="Export for prompt training">
                        <i class="fas fa-database text-sm"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- INFO BANNER -->
        <div class="px-4 pt-4">
            <div class="p-3 bg-dot-blue/10 border border-dot-blue/30 text-sm text-slate-600 flex items-center gap-2">
                <i class="fas fa-edit text-dot-blue"></i>
                <span class="flex-1">Review and edit your report sections below. Changes are saved automatically.</span>
                <button id="refine-all-btn" onclick="refineAll()" class="px-4 py-2 bg-violet-600 hover:bg-violet-700 text-white text-xs font-bold uppercase transition-colors flex items-center gap-2 whitespace-nowrap">
                    <i class="fas fa-magic"></i>
                    <span>Refine All</span>
                </button>
            </div>
        </div>

        <!-- SECTIONS LIST -->
        <main class="flex-1 p-4 pb-8 space-y-3 overflow-y-auto hide-scrollbar">

            <!-- Weather Section -->
            <div id="weather-section" class="bg-white border-2 border-slate-200" data-section="weather">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-sky-500 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-cloud-sun text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Weather & Site Conditions</p>
                    <button id="weather-refine-btn" onclick="refineSection('weather')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="weather-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter weather and site conditions..." oninput="handleOriginalEdit('weather')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="weather-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('weather')"></div>
                    </div>
                </div>
            </div>

            <!-- Work Summary Section -->
            <div id="activities-section" class="bg-white border-2 border-slate-200" data-section="activities">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-safety-green flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-tasks text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Work Summary</p>
                    <button id="activities-refine-btn" onclick="refineSection('activities')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="activities-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter work summary..." oninput="handleOriginalEdit('activities')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="activities-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('activities')"></div>
                    </div>
                </div>
            </div>

            <!-- Issues Section -->
            <div id="issues-section" class="bg-white border-2 border-slate-200" data-section="issues">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-red-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Issues & Delays</p>
                    <span id="issues-na-badge" class="hidden px-2 py-1 bg-slate-200 text-slate-600 text-[10px] font-bold uppercase">N/A</span>
                    <button id="issues-refine-btn" onclick="refineSection('issues')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="issues-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter issues and delays..." oninput="handleOriginalEdit('issues')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="issues-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('issues')"></div>
                    </div>
                </div>
            </div>

            <!-- Inspections Section -->
            <div id="inspections-section" class="bg-white border-2 border-slate-200" data-section="inspections">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-violet-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-check-double text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">QA/QC Inspections</p>
                    <span id="inspections-na-badge" class="hidden px-2 py-1 bg-slate-200 text-slate-600 text-[10px] font-bold uppercase">N/A</span>
                    <button id="inspections-refine-btn" onclick="refineSection('inspections')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="inspections-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter inspections..." oninput="handleOriginalEdit('inspections')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="inspections-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('inspections')"></div>
                    </div>
                </div>
            </div>

            <!-- Safety Section -->
            <div id="safety-section" class="bg-white border-2 border-slate-200" data-section="safety">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-dot-orange flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-hard-hat text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Safety</p>
                    <button id="safety-refine-btn" onclick="refineSection('safety')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="safety-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter safety notes..." oninput="handleOriginalEdit('safety')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="safety-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('safety')"></div>
                    </div>
                </div>
            </div>

            <!-- Visitors Section -->
            <div id="visitors-section" class="bg-white border-2 border-slate-200" data-section="visitors">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-dot-blue flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user-tie text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Visitors & Communications</p>
                    <span id="visitors-na-badge" class="hidden px-2 py-1 bg-slate-200 text-slate-600 text-[10px] font-bold uppercase">N/A</span>
                    <button id="visitors-refine-btn" onclick="refineSection('visitors')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="visitors-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter visitors and communications..." oninput="handleOriginalEdit('visitors')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="visitors-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('visitors')"></div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="bg-white border-2 border-slate-200" data-section="photos">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-dot-navy flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-camera text-dot-yellow text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Progress Photos</p>
                </div>
                <div class="p-3">
                    <div id="photos-grid" class="grid grid-cols-3 md:grid-cols-5 gap-2">
                        <!-- Dynamic photos -->
                    </div>
                </div>
            </div>

            <!-- Additional Notes Section -->
            <div id="notes-section" class="bg-white border-2 border-slate-200" data-section="notes">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center gap-3">
                    <div class="w-9 h-9 bg-slate-600 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-sticky-note text-white text-sm"></i>
                    </div>
                    <p class="font-bold text-slate-800 uppercase text-sm flex-1">Additional Notes</p>
                    <button id="additionalNotes-refine-btn" onclick="refineSection('additionalNotes')" class="px-3 py-1.5 bg-violet-600 hover:bg-violet-700 text-white text-[10px] font-bold uppercase transition-colors flex items-center gap-1.5">
                        <i class="fas fa-magic"></i>
                        <span>Refine</span>
                    </button>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-slate-200">
                    <div class="p-3">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">Original</p>
                        <div id="notes-original" class="editable-area text-sm text-slate-600 border border-slate-200 bg-slate-50" contenteditable="true" data-placeholder="Enter additional notes..." oninput="handleOriginalEdit('notes')">Loading...</div>
                    </div>
                    <div class="p-3 bg-safety-green/5">
                        <p class="text-[10px] font-bold text-safety-green uppercase tracking-wide mb-2">Edited</p>
                        <div id="notes-refined" class="editable-area text-sm text-slate-700 border border-safety-green/30 bg-white" contenteditable="true" data-placeholder="Enter your edited version here..." oninput="handleEdit('notes')"></div>
                    </div>
                </div>
            </div>

        </main>

        <!-- BOTTOM ACTION -->
        <div class="sticky bottom-0 p-4 bg-dot-navy border-t-2 border-dot-yellow">
            <button onclick="saveAndViewReport()" class="w-full p-3 bg-safety-green hover:bg-green-700 text-white text-center font-bold uppercase text-sm transition-colors">
                <i class="fas fa-save mr-2"></i>Save & View Report
            </button>
        </div>

        <!-- Footer -->
        <footer class="bg-dot-navy text-center py-2 border-t border-slate-700">
            <p class="text-[10px] text-slate-500 uppercase tracking-widest">DOT Compliant Field Documentation System</p>
        </footer>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submit-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-dot-orange/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-cloud-upload-alt text-dot-orange text-xl"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-slate-800">Submit Report</h3>
                    <p class="text-sm text-slate-500">This action cannot be undone</p>
                </div>
            </div>
            <p class="text-slate-600 mb-6">Are you sure you want to submit this report? This will save it to the project database.</p>
            <div class="flex gap-3 justify-end">
                <button onclick="hideSubmitConfirmation()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-bold text-sm hover:bg-slate-200 transition-colors">
                    Cancel
                </button>
                <button id="confirm-submit-btn" onclick="submitReport()" class="px-4 py-2 bg-dot-orange text-white rounded-lg font-bold text-sm shadow-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-cloud-upload-alt mr-1"></i> Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Cancel Report Confirmation Modal -->
    <div id="cancel-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-lg overflow-hidden">
            <div class="bg-red-600 text-white p-6 text-center">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <p class="text-xl font-bold uppercase">Cancel Report?</p>
                <p class="text-sm text-white/80 mt-1">This action cannot be undone</p>
            </div>
            <div class="p-4">
                <p class="text-slate-600 text-sm text-center mb-4">Are you sure you want to cancel this report? All data entered today will be permanently deleted.</p>
                <div class="space-y-2">
                    <button onclick="cancelReport()" class="w-full p-4 bg-red-600 hover:bg-red-700 text-white font-bold uppercase rounded-lg transition-colors">
                        <i class="fas fa-trash mr-2"></i>Yes, Cancel Report
                    </button>
                    <button onclick="hideCancelConfirmation()" class="w-full p-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold uppercase rounded-lg transition-colors">
                        No, Keep Working
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        const N8N_REFINE_WEBHOOK = "https://advidere.app.n8n.cloud/webhook/fieldvoice-refine";
        const N8N_SUBMIT_WEBHOOK = "https://advidere.app.n8n.cloud/webhook/fieldvoice-submit";

        // ============ STATE ============
        let report = null;
        let refinedData = {};
        let naSections = {};
        let isRefining = {}; // Track which sections are currently being refined

        // ============ STORAGE ============
        function getTodayKey() {
            return `fieldvoice_report_${new Date().toISOString().split('T')[0]}`;
        }

        function getReport() {
            const saved = localStorage.getItem(getTodayKey());
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }
            const legacy = localStorage.getItem('fieldvoice_report');
            if (legacy) {
                try {
                    const parsed = JSON.parse(legacy);
                    if (!parsed.meta) parsed.meta = {};
                    if (!parsed.meta.naMarked) parsed.meta.naMarked = {};
                    if (!parsed.safety) parsed.safety = { hasIncidents: false, noIncidents: false, notes: [] };
                    if (parsed.safety.noIncidents === undefined) parsed.safety.noIncidents = false;
                    if (!parsed.refinedData) parsed.refinedData = {};
                    return parsed;
                } catch (e) {}
            }
            return null;
        }

        function saveReport() {
            localStorage.setItem(getTodayKey(), JSON.stringify(report));
            localStorage.setItem('fieldvoice_report', JSON.stringify(report));
        }


        // ============ HANDLE EDITS ============
        function handleEdit(section) {
            const refinedEl = document.getElementById(`${section}-refined`);
            const text = refinedEl.innerText.trim();
            refinedData[section] = text;
            saveRefinedDataToReport();
        }

        function handleOriginalEdit(section) {
            const originalEl = document.getElementById(`${section}-original`);
            const text = originalEl.innerText.trim();

            switch (section) {
                case 'weather':
                    report.overview.weather.jobSiteCondition = text;
                    break;
                case 'activities':
                    if (report.activities.length > 0) {
                        report.activities = [{
                            contractor: 'General',
                            trade: 'General',
                            narrative: text
                        }];
                    } else {
                        report.activities.push({
                            contractor: 'General',
                            trade: 'General',
                            narrative: text
                        });
                    }
                    break;
                case 'issues':
                    report.generalIssues = text ? [text] : [];
                    break;
                case 'inspections':
                    report.qaqcNotes = text ? [text] : [];
                    break;
                case 'safety':
                    report.safety.notes = text ? [text] : [];
                    break;
                case 'visitors':
                    report.visitorsRemarks = text ? [text] : [];
                    break;
                case 'notes':
                    report.additionalNotes = text;
                    break;
            }

            saveReport();
        }

        function saveRefinedDataToReport() {
            if (!report) return;

            if (!report.refinedData) {
                report.refinedData = {};
            }

            Object.keys(refinedData).forEach(section => {
                if (refinedData[section]) {
                    report.refinedData[section] = refinedData[section];
                }
            });

            saveReport();
        }

        // ============ PHOTO CAPTION FUNCTIONS ============
        function escapeHtmlForTextarea(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');
        }

        function autoExpandPhotoCaptionTextarea(textarea) {
            textarea.style.height = 'auto';
            const maxHeight = parseFloat(getComputedStyle(textarea).maxHeight) || 96;
            const newHeight = Math.min(textarea.scrollHeight, maxHeight);
            textarea.style.height = newHeight + 'px';
            textarea.style.overflowY = textarea.scrollHeight > maxHeight ? 'auto' : 'hidden';
        }

        function handlePhotoCaptionInput(textarea, index) {
            autoExpandPhotoCaptionTextarea(textarea);

            const value = textarea.value;
            const length = value.length;

            const counter = document.getElementById(`photo-caption-counter-${index}`);
            if (counter) {
                counter.textContent = `${length}/500`;
                counter.style.display = length > 400 ? 'block' : 'none';
                counter.classList.remove('warning', 'error');
                if (length > 500) {
                    counter.classList.add('error');
                } else if (length > 400) {
                    counter.classList.add('warning');
                }
            }

            if (report.photos && report.photos[index]) {
                report.photos[index].caption = value.substring(0, 500);
            }
        }

        function savePhotoCaption(index) {
            const textarea = document.querySelector(`textarea[data-photo-index="${index}"]`);
            if (textarea && report.photos && report.photos[index]) {
                const value = textarea.value.substring(0, 500);
                report.photos[index].caption = value;
                saveReport();
            }
        }

        // Save captions when navigating away
        window.addEventListener('beforeunload', function() {
            document.querySelectorAll('.photo-caption-input').forEach(textarea => {
                const index = parseInt(textarea.dataset.photoIndex);
                if (!isNaN(index) && report?.photos?.[index]) {
                    report.photos[index].caption = textarea.value.substring(0, 500);
                }
            });
            if (report) saveReport();
        });

        // ============ DISPLAY ORIGINAL DATA ============
        function displayOriginalData() {
            if (!report) return;

            const naMarked = report.meta?.naMarked || {};

            // Weather
            const weatherText = report.overview?.weather?.jobSiteCondition ||
                `${report.overview?.weather?.generalCondition || 'N/A'}, High: ${report.overview?.weather?.highTemp || '--'}, Low: ${report.overview?.weather?.lowTemp || '--'}`;
            document.getElementById('weather-original').textContent = weatherText || 'No weather data';

            // Activities
            const activitiesText = report.activities?.map(a => a.narrative).join('\n\n') || 'No activities recorded';
            document.getElementById('activities-original').innerHTML = activitiesText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';

            // Issues - check for N/A
            if (naMarked.issues) {
                naSections.issues = true;
                document.getElementById('issues-section').classList.add('section-na');
                document.getElementById('issues-na-badge').classList.remove('hidden');
                document.getElementById('issues-refine-btn').classList.add('hidden');
                document.getElementById('issues-original').innerHTML = '<span class="text-slate-400 italic">N/A - No issues reported</span>';
                document.getElementById('issues-refined').innerHTML = '<span class="text-slate-400 italic">N/A</span>';
                document.getElementById('issues-refined').contentEditable = 'false';
            } else {
                const issuesText = report.generalIssues?.join('\n\n') || 'No issues recorded';
                document.getElementById('issues-original').innerHTML = issuesText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';
            }

            // Inspections - check for N/A
            if (naMarked.inspections) {
                naSections.inspections = true;
                document.getElementById('inspections-section').classList.add('section-na');
                document.getElementById('inspections-na-badge').classList.remove('hidden');
                document.getElementById('inspections-refine-btn').classList.add('hidden');
                document.getElementById('inspections-original').innerHTML = '<span class="text-slate-400 italic">N/A - No inspections</span>';
                document.getElementById('inspections-refined').innerHTML = '<span class="text-slate-400 italic">N/A</span>';
                document.getElementById('inspections-refined').contentEditable = 'false';
            } else {
                const inspectionsText = report.qaqcNotes?.join('\n\n') || 'No inspections recorded';
                document.getElementById('inspections-original').innerHTML = inspectionsText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';
            }

            // Safety
            let safetyText = '';
            if (report.safety?.hasIncidents) {
                safetyText = 'INCIDENT REPORTED\n\n';
            } else if (report.safety?.noIncidents) {
                safetyText = 'No incidents reported.\n\n';
            }
            safetyText += report.safety?.notes?.join('\n\n') || '';
            document.getElementById('safety-original').innerHTML = safetyText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';

            // Visitors - check for N/A
            if (naMarked.visitors) {
                naSections.visitors = true;
                document.getElementById('visitors-section').classList.add('section-na');
                document.getElementById('visitors-na-badge').classList.remove('hidden');
                document.getElementById('visitors-refine-btn').classList.add('hidden');
                document.getElementById('visitors-original').innerHTML = '<span class="text-slate-400 italic">N/A - No visitors</span>';
                document.getElementById('visitors-refined').innerHTML = '<span class="text-slate-400 italic">N/A</span>';
                document.getElementById('visitors-refined').contentEditable = 'false';
            } else {
                const visitorsText = report.visitorsRemarks?.join('\n\n') || 'No visitors recorded';
                document.getElementById('visitors-original').innerHTML = visitorsText.replace(/\n/g, '<br>') || '<span class="text-slate-400 italic">No data</span>';
            }

            // Photos
            const photosGrid = document.getElementById('photos-grid');
            if (report.photos?.length > 0) {
                photosGrid.innerHTML = report.photos.map((p, i) => `
                    <div class="bg-slate-100 border border-slate-200 overflow-hidden">
                        <div class="relative aspect-square">
                            <img src="${p.url}" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-1.5">
                                <p class="text-[9px] text-white/80">${p.time || ''}</p>
                            </div>
                        </div>
                        <div class="p-1.5 bg-white">
                            <textarea
                                class="photo-caption-input"
                                placeholder="Add caption..."
                                maxlength="500"
                                data-photo-index="${i}"
                                oninput="handlePhotoCaptionInput(this, ${i})"
                                onblur="savePhotoCaption(${i})"
                            >${escapeHtmlForTextarea(p.caption || '')}</textarea>
                            <div id="photo-caption-counter-${i}" class="photo-caption-counter" style="display: ${(p.caption?.length || 0) > 400 ? 'block' : 'none'}">
                                ${p.caption?.length || 0}/500
                            </div>
                        </div>
                    </div>
                `).join('');
                // Auto-expand textareas
                document.querySelectorAll('.photo-caption-input').forEach(autoExpandPhotoCaptionTextarea);
            } else {
                photosGrid.innerHTML = '<p class="text-slate-400 italic text-sm col-span-full text-center py-4">No photos</p>';
            }

            // Additional Notes
            const notesText = report.additionalNotes || '';
            document.getElementById('notes-original').innerHTML = notesText ? notesText.replace(/\n/g, '<br>') : '<span class="text-slate-400 italic">No additional notes</span>';

            // Load previously saved refined data
            if (report.refinedData) {
                Object.keys(report.refinedData).forEach(section => {
                    if (report.refinedData[section] && !naSections[section]) {
                        refinedData[section] = report.refinedData[section];
                        const refinedEl = document.getElementById(`${section}-refined`);
                        if (refinedEl) {
                            refinedEl.innerHTML = report.refinedData[section].replace(/\n/g, '<br>');
                        }
                    }
                });
            }
        }


        // ============ SAVE & VIEW ============
        function saveAndViewReport() {
            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors', 'notes'];
            sections.forEach(section => {
                if (!naSections[section]) {
                    const refinedEl = document.getElementById(`${section}-refined`);
                    const text = refinedEl.innerText.trim();
                    if (text && !text.includes('Enter your edited')) {
                        refinedData[section] = text;
                    }
                }
            });

            saveRefinedDataToReport();
            showToast('Report saved!');

            setTimeout(() => {
                window.location.href = 'report.html';
            }, 500);
        }

        function saveAndExport() {
            saveRefinedDataToReport();

            let exportText = `DAILY REPORT - ${report?.overview?.date || new Date().toLocaleDateString()}\n`;
            exportText += `Project: ${report?.overview?.projectName || 'N/A'}\n`;
            exportText += `${'='.repeat(50)}\n\n`;

            const sections = [
                { id: 'weather', title: 'WEATHER & SITE CONDITIONS' },
                { id: 'activities', title: 'WORK SUMMARY' },
                { id: 'issues', title: 'ISSUES & DELAYS' },
                { id: 'inspections', title: 'QA/QC INSPECTIONS' },
                { id: 'safety', title: 'SAFETY' },
                { id: 'visitors', title: 'VISITORS & COMMUNICATIONS' },
                { id: 'notes', title: 'ADDITIONAL NOTES' }
            ];

            sections.forEach(section => {
                exportText += `${section.title}\n${'-'.repeat(section.title.length)}\n`;

                if (naSections[section.id]) {
                    exportText += 'N/A\n\n';
                } else {
                    const refined = refinedData[section.id];
                    const original = document.getElementById(`${section.id}-original`)?.textContent;
                    exportText += (refined || original || 'N/A') + '\n\n';
                }
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `daily-report-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportTrainingData() {
            saveRefinedDataToReport();
            showToast('Preparing report...', 'info');

            const currentDate = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const exportDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // Detect if running as installed PWA
            const isInstalledPWA = window.navigator.standalone === true ||
                                   window.matchMedia('(display-mode: standalone)').matches;

            const sections = [
                { id: 'weather', title: 'Weather & Site Conditions', icon: 'ðŸŒ¤ï¸' },
                { id: 'activities', title: 'Work Summary', icon: 'ðŸ“‹' },
                { id: 'issues', title: 'Issues & Delays', icon: 'âš ï¸' },
                { id: 'inspections', title: 'QA/QC Inspections', icon: 'âœ…' },
                { id: 'safety', title: 'Safety', icon: 'ðŸ¦º' },
                { id: 'visitors', title: 'Visitors & Communications', icon: 'ðŸ‘¥' },
                { id: 'notes', title: 'Additional Notes', icon: 'ðŸ“' }
            ];

            // Build sections HTML
            let sectionsHtml = '';
            sections.forEach(section => {
                const originalEl = document.getElementById(`${section.id}-original`);
                const refinedEl = document.getElementById(`${section.id}-refined`);
                const originalText = originalEl?.innerText?.trim() || '';
                const refinedText = refinedEl?.innerText?.trim() || '';

                sectionsHtml += `
                <div class="section">
                    <h2>${section.icon} ${section.title}</h2>
                    ${naSections[section.id] ? `
                        <div class="na-badge">N/A - Not Applicable</div>
                    ` : `
                        <div class="content-grid">
                            <div class="content-box original">
                                <div class="content-label">Original</div>
                                <div class="content-text">${escapeHtml(originalText) || '<em>No input provided</em>'}</div>
                            </div>
                            <div class="content-box edited">
                                <div class="content-label">Edited</div>
                                <div class="content-text">${(refinedText && !refinedText.includes('Enter your edited')) ? escapeHtml(refinedText) : '<em>Not edited</em>'}</div>
                            </div>
                        </div>
                    `}
                </div>`;
            });

            // Process photos with metadata burned onto them
            let photosHtml = '';
            const photos = report.photos || [];
            if (photos.length > 0) {
                showToast(`Processing ${photos.length} photo(s)...`, 'info');

                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    try {
                        const processedDataUrl = await processPhotoWithMetadata(photo, i + 1);
                        if (processedDataUrl) {
                            photosHtml += `
                            <div class="photo-container">
                                <div class="photo-number">Photo ${i + 1} of ${photos.length}</div>
                                <img src="${processedDataUrl}" alt="Photo ${i + 1}">
                                ${photo.caption ? `<div class="photo-caption">${escapeHtml(photo.caption)}</div>` : ''}
                            </div>`;
                        }
                    } catch (err) {
                        console.error(`Error processing photo ${i + 1}:`, err);
                    }
                }
            }

            // Build the complete HTML document
            const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FieldVoice Pro Export - ${exportDate}</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #1e293b;
            background: #f8fafc;
            padding: 0;
            margin: 0;
        }
        .export-banner {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 14px;
        }
        .export-banner .title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .export-banner .instruction {
            opacity: 0.95;
            font-size: 13px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 100%);
            color: white;
            padding: 30px 20px;
            margin-bottom: 20px;
            border-bottom: 4px solid #f59e0b;
        }
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .header .meta {
            font-size: 14px;
            opacity: 0.9;
        }
        .header .meta span {
            display: inline-block;
            margin-right: 20px;
        }
        .section {
            background: white;
            border: 1px solid #e2e8f0;
            margin-bottom: 16px;
            page-break-inside: avoid;
        }
        .section h2 {
            background: #f1f5f9;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
        }
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }
        @media (max-width: 600px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        .content-box {
            padding: 16px;
        }
        .content-box.original {
            background: #fafafa;
            border-right: 1px solid #e2e8f0;
        }
        @media (max-width: 600px) {
            .content-box.original {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }
        .content-box.edited {
            background: #f0fdf4;
        }
        .content-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .original .content-label {
            color: #64748b;
        }
        .edited .content-label {
            color: #16a34a;
        }
        .content-text {
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
            user-select: text;
            -webkit-user-select: text;
        }
        .content-text em {
            color: #94a3b8;
            font-style: italic;
        }
        .na-badge {
            padding: 16px;
            color: #64748b;
            font-style: italic;
            background: #f8fafc;
        }
        .photos-section {
            background: white;
            border: 1px solid #e2e8f0;
            margin-bottom: 16px;
        }
        .photos-section h2 {
            background: #0a1628;
            color: #f59e0b;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .photo-container {
            padding: 16px;
            border-bottom: 1px solid #e2e8f0;
            page-break-inside: avoid;
        }
        .photo-container:last-child {
            border-bottom: none;
        }
        .photo-number {
            font-size: 12px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        .photo-container img {
            width: 100%;
            height: auto;
            display: block;
            border: 1px solid #e2e8f0;
        }
        .photo-caption {
            margin-top: 8px;
            padding: 10px 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-size: 13px;
            font-style: italic;
            color: #64748b;
            line-height: 1.4;
            user-select: text;
            -webkit-user-select: text;
        }
        .footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 12px;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        @media print {
            .export-banner {
                display: none;
            }
            body {
                background: white;
            }
            .container {
                padding: 0;
                max-width: none;
            }
            .section, .photos-section {
                box-shadow: none;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            .photo-container {
                page-break-inside: avoid;
            }
            .header {
                background: #0a1628 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="export-banner">
        <div class="title">FieldVoice Pro Export - ${exportDate}</div>
        <div class="instruction">Use your device's share or save function to keep this file</div>
    </div>

    <div class="header">
        <div class="container">
            <h1>Daily Field Report</h1>
            <div class="meta">
                <span>ðŸ“… ${currentDate}</span>
                <span>ðŸ“ ${escapeHtml(report?.overview?.projectName || 'N/A')}</span>
            </div>
        </div>
    </div>

    <div class="container">
        ${sectionsHtml}

        ${photos.length > 0 ? `
        <div class="photos-section">
            <h2>ðŸ“· Progress Photos</h2>
            ${photosHtml || '<div class="na-badge">Photos could not be processed</div>'}
        </div>
        ` : ''}

        <div class="footer">
            Generated on ${new Date().toLocaleString()} | FieldVoice Pro - DOT Compliant Field Documentation
        </div>
    </div>
</body>
</html>`;

            // Create blob and file for sharing/downloading
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const fileName = `daily-report-${new Date().toISOString().split('T')[0]}.html`;

            // Check if we should use Web Share API (PWA on iOS with share support)
            if (isInstalledPWA && navigator.share) {
                try {
                    const file = new File([blob], fileName, { type: 'text/html' });

                    // Check if the browser can share files
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        showToast('Opening share sheet...', 'info');

                        await navigator.share({
                            files: [file],
                            title: `Daily Report - ${exportDate}`,
                            text: 'Field report with photos and metadata'
                        });

                        showToast('Share sheet opened', 'success');
                        return;
                    }
                } catch (err) {
                    // User cancelled share or share failed
                    if (err.name !== 'AbortError') {
                        console.error('Share failed:', err);
                    }
                    // Fall through to other methods
                }
            }

            // For regular browsers (not PWA), use window.open approach
            if (!isInstalledPWA) {
                try {
                    const newWindow = window.open('', '_blank');
                    if (newWindow) {
                        newWindow.document.write(htmlContent);
                        newWindow.document.close();
                        showToast('Report opened in new tab', 'success');
                        return;
                    }
                } catch (err) {
                    console.error('Window.open failed:', err);
                }
            }

            // Fallback: Navigate to blob URL (works in PWA but user needs to use back gesture)
            try {
                const url = URL.createObjectURL(blob);

                // Store current location so we can potentially navigate back
                sessionStorage.setItem('fieldvoice_pre_export_url', window.location.href);

                // For PWA, navigate in same window (share/save from there)
                if (isInstalledPWA) {
                    showToast('Report opened - use Share to save', 'info');
                    window.location.href = url;
                } else {
                    // Try opening in new tab one more time
                    const opened = window.open(url, '_blank');
                    if (opened) {
                        showToast('Report opened in new tab', 'success');
                    } else {
                        // Last resort: trigger download
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        showToast('Report downloaded', 'success');
                    }
                    // Clean up blob URL after a delay
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                }
            } catch (err) {
                console.error('Export failed:', err);
                showToast('Export failed - please try again', 'error');
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Process a single photo: draw at original size with metadata overlay
        function processPhotoWithMetadata(photo, photoNumber) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = function() {
                    // Create canvas at original image dimensions
                    const canvas = document.createElement('canvas');
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');

                    // Draw the original image at full size
                    ctx.drawImage(img, 0, 0);

                    // Prepare metadata text
                    const lines = [];

                    // Add timestamp
                    if (photo.timestamp) {
                        const date = new Date(photo.timestamp);
                        const formattedDate = date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        const formattedTime = date.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        lines.push(`${formattedDate} ${formattedTime}`);
                    } else if (photo.time) {
                        lines.push(photo.time);
                    }

                    // Add GPS coordinates
                    if (photo.gps && (photo.gps.latitude || photo.gps.lat)) {
                        const lat = photo.gps.latitude || photo.gps.lat;
                        const lon = photo.gps.longitude || photo.gps.lon || photo.gps.lng;
                        if (lat && lon) {
                            const latStr = Math.abs(lat).toFixed(6) + 'Â° ' + (lat >= 0 ? 'N' : 'S');
                            const lonStr = Math.abs(lon).toFixed(6) + 'Â° ' + (lon >= 0 ? 'E' : 'W');
                            lines.push(`GPS: ${latStr}, ${lonStr}`);
                        }
                    }

                    // Add project name if available
                    if (report?.overview?.projectName) {
                        lines.push(report.overview.projectName);
                    }

                    // Draw metadata overlay if we have any text
                    if (lines.length > 0) {
                        // Calculate font size based on image dimensions (responsive)
                        const baseFontSize = Math.max(16, Math.min(canvas.width, canvas.height) * 0.025);
                        const padding = baseFontSize * 0.8;
                        const lineHeight = baseFontSize * 1.4;

                        ctx.font = `bold ${baseFontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif`;

                        // Calculate text dimensions
                        let maxWidth = 0;
                        lines.forEach(line => {
                            const metrics = ctx.measureText(line);
                            maxWidth = Math.max(maxWidth, metrics.width);
                        });

                        const boxWidth = maxWidth + padding * 2;
                        const boxHeight = lines.length * lineHeight + padding * 2;

                        // Position at bottom-left corner
                        const boxX = padding;
                        const boxY = canvas.height - boxHeight - padding;

                        // Draw semi-transparent background
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        ctx.fillRect(boxX, boxY, boxWidth, boxHeight);

                        // Draw border
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(boxX, boxY, boxWidth, boxHeight);

                        // Draw text
                        ctx.fillStyle = '#ffffff';
                        ctx.textBaseline = 'top';
                        lines.forEach((line, index) => {
                            ctx.fillText(line, boxX + padding, boxY + padding + index * lineHeight);
                        });
                    }

                    // Export as JPEG at high quality
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                    resolve(dataUrl);
                };

                img.onerror = function() {
                    console.error('Failed to load image for photo', photoNumber);
                    resolve(null);
                };

                // Load the image from base64 or URL
                img.src = photo.url;
            });
        }

        function copyToClipboard() {
            let copyText = '';

            const sections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors', 'notes'];
            sections.forEach(section => {
                if (naSections[section]) {
                    return;
                }
                const refined = refinedData[section];
                const original = document.getElementById(`${section}-original`)?.textContent;
                if (refined || original) {
                    copyText += (refined || original) + '\n\n';
                }
            });

            navigator.clipboard.writeText(copyText).then(() => {
                showToast('Copied to clipboard!');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast-msg');
            if (existing) existing.remove();

            const colors = { success: 'bg-safety-green', warning: 'bg-dot-orange', error: 'bg-red-600', info: 'bg-dot-blue' };
            const toast = document.createElement('div');
            toast.className = `toast-msg fixed bottom-24 left-1/2 -translate-x-1/2 ${colors[type] || colors.success} text-white px-6 py-3 font-bold text-sm shadow-lg z-50 flex items-center gap-2 uppercase`;
            toast.innerHTML = `<i class="fas fa-check"></i>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ============ AI REFINEMENT ============

        // Map section IDs to webhook section names
        const sectionNameMap = {
            'weather': 'weather',
            'activities': 'activities',
            'issues': 'issues',
            'inspections': 'inspections',
            'safety': 'safety',
            'visitors': 'visitors',
            'notes': 'additionalNotes',
            'additionalNotes': 'additionalNotes'
        };

        // Map section IDs to element IDs (handles the notes/additionalNotes discrepancy)
        const sectionElementMap = {
            'weather': 'weather',
            'activities': 'activities',
            'issues': 'issues',
            'inspections': 'inspections',
            'safety': 'safety',
            'visitors': 'visitors',
            'notes': 'notes',
            'additionalNotes': 'notes'
        };

        // Get original text for a section
        function getOriginalText(section) {
            const elementId = sectionElementMap[section] || section;
            const originalEl = document.getElementById(`${elementId}-original`);
            if (!originalEl) return '';
            return originalEl.innerText.trim();
        }

        // Set refine button state (loading/normal/error)
        function setRefineButtonState(section, state, errorMsg = '') {
            // Handle additionalNotes special case
            const btnId = section === 'notes' ? 'additionalNotes-refine-btn' : `${section}-refine-btn`;
            const btn = document.getElementById(btnId);
            if (!btn) return;

            switch (state) {
                case 'loading':
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Refining...</span>';
                    break;
                case 'error':
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.classList.add('bg-red-600', 'hover:bg-red-700');
                    btn.classList.remove('bg-violet-600', 'hover:bg-violet-700');
                    btn.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Retry</span>';
                    break;
                case 'normal':
                default:
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-red-600', 'hover:bg-red-700');
                    btn.classList.add('bg-violet-600', 'hover:bg-violet-700');
                    btn.innerHTML = '<i class="fas fa-magic"></i><span>Refine</span>';
                    break;
            }
        }

        // Type text with animation effect
        async function typeText(element, text) {
            element.innerHTML = '';
            const chars = text.split('');
            let currentText = '';

            for (let i = 0; i < chars.length; i++) {
                currentText += chars[i];
                element.innerHTML = currentText.replace(/\n/g, '<br>');

                // Variable speed: faster for spaces, slower for punctuation
                let delay = 5;
                if (chars[i] === '.' || chars[i] === '!' || chars[i] === '?') {
                    delay = 50;
                } else if (chars[i] === ',') {
                    delay = 25;
                } else if (chars[i] === ' ') {
                    delay = 2;
                }

                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }

        // Refine a single section via webhook
        async function refineSection(section) {
            const elementId = sectionElementMap[section] || section;
            const webhookSection = sectionNameMap[section] || section;

            // Check if offline first
            if (!navigator.onLine) {
                showToast('You are offline - AI refinement requires internet connection', 'error');
                return false;
            }

            // Check if section is marked as N/A
            if (naSections[elementId]) {
                showToast('Section marked as N/A', 'warning');
                return false;
            }

            // Check if already refining
            if (isRefining[section]) {
                return false;
            }

            const originalText = getOriginalText(section);
            if (!originalText || originalText === 'Loading...' || originalText.includes('No ') || originalText.includes('N/A')) {
                showToast('No content to refine', 'warning');
                return false;
            }

            isRefining[section] = true;
            setRefineButtonState(elementId, 'loading');

            // Show loading state in refined area
            const refinedEl = document.getElementById(`${elementId}-refined`);
            if (refinedEl) {
                refinedEl.innerHTML = '<span class="text-violet-600"><i class="fas fa-spinner fa-spin mr-2"></i>Refining with AI...</span>';
            }

            try {
                // Build the payload
                const payload = {
                    section: webhookSection,
                    originalText: originalText,
                    reportContext: {
                        projectName: report?.overview?.projectName || 'Unknown Project',
                        reporterName: report?.overview?.reporterName || 'Unknown Reporter',
                        date: report?.overview?.date || new Date().toLocaleDateString()
                    }
                };

                // Create abort controller for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(N8N_REFINE_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();

                if (!data.refinedText) {
                    throw new Error('Invalid response: missing refinedText');
                }

                // Type the refined text with animation
                if (refinedEl) {
                    await typeText(refinedEl, data.refinedText);
                }

                // Save the refined data
                refinedData[elementId] = data.refinedText;
                saveRefinedDataToReport();

                setRefineButtonState(elementId, 'normal');
                isRefining[section] = false;
                return true;

            } catch (error) {
                console.error('Refine error:', error);
                isRefining[section] = false;

                let errorMessage = 'Refinement failed';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out (30s)';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Network error - check connection';
                } else if (error.message.includes('Invalid response')) {
                    errorMessage = 'Invalid response from server';
                } else if (error.message.includes('Server error')) {
                    errorMessage = error.message;
                }

                if (refinedEl) {
                    refinedEl.innerHTML = `<span class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${errorMessage}</span>`;
                }

                setRefineButtonState(elementId, 'error');
                showToast(errorMessage, 'error');
                return false;
            }
        }

        // Refine all sections sequentially
        async function refineAll() {
            const allSections = ['weather', 'activities', 'issues', 'inspections', 'safety', 'visitors', 'notes'];
            const sectionsToRefine = allSections.filter(section => !naSections[section]);

            if (sectionsToRefine.length === 0) {
                showToast('No sections to refine', 'warning');
                return;
            }

            // Update the Refine All button to show progress
            const refineAllBtn = document.getElementById('refine-all-btn');
            const originalBtnHtml = refineAllBtn.innerHTML;
            refineAllBtn.disabled = true;
            refineAllBtn.classList.add('opacity-50', 'cursor-not-allowed');

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < sectionsToRefine.length; i++) {
                const section = sectionsToRefine[i];

                // Update progress indicator
                refineAllBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>Refining ${i + 1} of ${sectionsToRefine.length}...</span>`;

                // Check if there's actual content to refine
                const originalText = getOriginalText(section);
                if (!originalText || originalText === 'Loading...' || originalText.includes('No ') || originalText.includes('N/A')) {
                    continue; // Skip empty sections
                }

                const success = await refineSection(section);
                if (success) {
                    successCount++;
                } else {
                    failCount++;
                }

                // Small delay between requests to avoid overwhelming the webhook
                if (i < sectionsToRefine.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            // Restore button state
            refineAllBtn.disabled = false;
            refineAllBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            refineAllBtn.innerHTML = originalBtnHtml;

            // Show completion message
            if (failCount === 0 && successCount > 0) {
                showToast(`Refined ${successCount} sections!`, 'success');
            } else if (successCount > 0) {
                showToast(`Refined ${successCount} sections, ${failCount} failed`, 'warning');
            } else if (failCount > 0) {
                showToast('All refinements failed', 'error');
            } else {
                showToast('No content to refine', 'info');
            }
        }

        // ============ SUBMIT REPORT ============

        // Show confirmation modal
        function showSubmitConfirmation() {
            // Save any pending edits first
            saveRefinedDataToReport();

            // Check if already submitted
            if (report.meta?.submitted) {
                showToast('This report has already been submitted', 'warning');
                return;
            }

            document.getElementById('submit-modal').classList.remove('hidden');
        }

        // Hide confirmation modal
        function hideSubmitConfirmation() {
            document.getElementById('submit-modal').classList.add('hidden');
        }

        // ============ CANCEL REPORT ============
        function showCancelConfirmation() {
            document.getElementById('cancel-modal').classList.remove('hidden');
        }

        function hideCancelConfirmation() {
            document.getElementById('cancel-modal').classList.add('hidden');
        }

        function cancelReport() {
            // Clear today's report data
            localStorage.removeItem(getTodayKey());
            localStorage.removeItem('fieldvoice_report');

            showToast('Report cancelled', 'info');

            // Redirect to dashboard after brief delay
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }

        // Gather all report data for submission
        function gatherReportData() {
            const o = report.overview || {};
            const w = o.weather || {};
            const safety = report.safety || { hasIncidents: false, notes: [] };
            const naMarked = report.meta?.naMarked || {};

            // Get refined or original text for each section
            const getTextContent = (section, originalData) => {
                if (naMarked[section]) return 'N/A';
                return refinedData[section] || report.refinedData?.[section] || originalData || '';
            };

            // Prepare activities text
            let workSummaryText = '';
            if (refinedData.activities || report.refinedData?.activities) {
                workSummaryText = refinedData.activities || report.refinedData.activities;
            } else if (report.activities?.length > 0) {
                workSummaryText = report.activities.map(a => a.narrative).join('\n\n');
            }

            // Prepare issues text
            let issuesText = getTextContent('issues', report.generalIssues?.join('\n\n') || '');

            // Prepare inspections text
            let inspectionsText = getTextContent('inspections', report.qaqcNotes?.join('\n\n') || '');

            // Prepare visitors text
            let visitorsText = '';
            if (naMarked.visitors) {
                visitorsText = 'N/A';
            } else if (refinedData.visitors || report.refinedData?.visitors) {
                visitorsText = refinedData.visitors || report.refinedData.visitors;
            } else {
                const visitorsContent = [...(report.visitorsRemarks || []), ...(report.communications || [])];
                visitorsText = visitorsContent.join('\n\n');
            }

            // Prepare safety text
            let safetyNotes = '';
            if (refinedData.safety || report.refinedData?.safety) {
                safetyNotes = refinedData.safety || report.refinedData.safety;
            } else if (safety.notes?.length > 0) {
                safetyNotes = safety.notes.join('\n\n');
            }

            // Prepare additional notes
            let additionalNotes = refinedData.notes || report.refinedData?.notes || report.additionalNotes || '';

            // Prepare photos array with base64 data
            const photos = (report.photos || []).map(p => ({
                id: p.id || `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                base64: p.url || '',
                timestamp: p.timestamp || null,
                gps: p.gps || null,
                caption: p.caption || ''
            }));

            return {
                submittedAt: new Date().toISOString(),
                reporter: {
                    name: report.reporter?.name || o.completedBy || ''
                },
                project: {
                    name: report.project?.name || o.projectName || '',
                    dayNumber: report.project?.dayNumber || null
                },
                date: o.date || new Date().toLocaleDateString(),
                startTime: o.startTime || '',
                endTime: o.endTime || '',
                shiftDuration: o.shiftDuration || '',
                weather: {
                    highTemp: w.highTemp || '',
                    lowTemp: w.lowTemp || '',
                    precipitation: w.precipitation || '',
                    generalCondition: w.generalCondition || '',
                    jobSiteCondition: w.jobSiteCondition || 'Dry'
                },
                workSummary: workSummaryText,
                issues: issuesText,
                inspections: inspectionsText,
                safety: {
                    hasIncidents: safety.hasIncidents || false,
                    notes: safetyNotes
                },
                visitors: visitorsText,
                additionalNotes: additionalNotes,
                photos: photos
            };
        }

        // Submit report to webhook
        async function submitReport() {
            const submitBtn = document.getElementById('submit-report-btn');
            const confirmBtn = document.getElementById('confirm-submit-btn');
            const originalBtnHtml = submitBtn.innerHTML;
            const originalConfirmHtml = confirmBtn.innerHTML;

            // Check if offline first
            if (!navigator.onLine) {
                hideSubmitConfirmation();
                showToast('You are offline - Please connect to the internet to submit your report', 'error');
                return;
            }

            // Set loading state
            submitBtn.disabled = true;
            confirmBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Submitting...';
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Submitting...';
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            confirmBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                const payload = gatherReportData();

                // Create abort controller for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout for photos

                const response = await fetch(N8N_SUBMIT_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                // Mark report as submitted
                if (!report.meta) report.meta = {};
                report.meta.submitted = true;
                report.meta.interviewCompleted = true;
                report.meta.submittedAt = new Date().toISOString();
                saveReport();

                hideSubmitConfirmation();
                showToast('Report submitted successfully!', 'success');

                // Redirect to index.html after brief delay to show success message
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);

            } catch (error) {
                console.error('Submit error:', error);

                // Restore button state
                submitBtn.disabled = false;
                confirmBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHtml;
                confirmBtn.innerHTML = originalConfirmHtml;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                confirmBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                let errorMessage = 'Failed to submit report';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out - please try again';
                } else if (error.message.includes('fetch')) {
                    errorMessage = 'Network error - check connection';
                } else if (error.message.includes('Server error')) {
                    errorMessage = error.message;
                }

                hideSubmitConfirmation();
                showToast(errorMessage, 'error');
            }
        }

        // Check if report was already submitted and update button
        function checkSubmittedStatus() {
            if (report?.meta?.submitted) {
                const submitBtn = document.getElementById('submit-report-btn');
                submitBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Submitted';
                submitBtn.classList.remove('bg-dot-orange', 'hover:bg-orange-700');
                submitBtn.classList.add('bg-safety-green', 'cursor-default');
                submitBtn.disabled = true;
            }
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });

            report = getReport();

            if (!report) {
                document.querySelector('main').innerHTML = `
                    <div class="text-center py-12 bg-white border-2 border-slate-200">
                        <i class="fas fa-inbox text-3xl text-slate-300 mb-3"></i>
                        <p class="text-slate-500 uppercase text-sm font-bold mb-4">No report found</p>
                        <a href="index.html" class="inline-block px-4 py-2 bg-dot-navy text-white font-bold uppercase text-sm">Go to Dashboard</a>
                    </div>
                `;
                return;
            }

            displayOriginalData();
            checkSubmittedStatus();
        });
    </script>

    <!-- PWA Navigation Fix - Prevent Safari from breaking out of standalone mode -->
    <script>
        (function() {
            // Only apply fix when running as installed PWA
            if (window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches) {
                document.addEventListener('click', function(e) {
                    const link = e.target.closest('a');
                    if (link && link.href && link.href.startsWith(window.location.origin)) {
                        // Internal link - prevent default and use location.href
                        e.preventDefault();
                        window.location.href = link.href;
                    }
                }, true);
            }
        })();
    </script>

    <!-- PWA Service Worker Registration & Offline Banner -->
    <div id="offline-banner" class="fixed top-0 left-0 right-0 bg-yellow-500 text-yellow-900 text-center py-2 px-4 font-bold text-sm z-[9999] transform -translate-y-full transition-transform duration-300" style="display: none;">
        <i class="fas fa-wifi-slash mr-2"></i>You are offline - Some features may be unavailable
    </div>
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('[PWA] Service Worker registered:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('[PWA] New version available');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('[PWA] Service Worker registration failed:', error);
                    });
            });
        }

        // Offline/Online Event Handlers
        const offlineBanner = document.getElementById('offline-banner');

        function showOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.display = 'block';
                setTimeout(() => {
                    offlineBanner.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        function hideOfflineBanner() {
            if (offlineBanner) {
                offlineBanner.style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    offlineBanner.style.display = 'none';
                }, 300);
            }
        }

        window.addEventListener('online', hideOfflineBanner);
        window.addEventListener('offline', showOfflineBanner);

        // Check initial state
        if (!navigator.onLine) {
            showOfflineBanner();
        }
    </script>
</body>
</html>
